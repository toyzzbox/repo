// generator client {
//   provider      = "prisma-client-js"
//   binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
// }

// datasource db {
//   provider = "postgresql"
//   url      = env("DATABASE_URL")
// }


generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}
/* =======================
   üßë USER & AUTH MODELLERƒ∞
======================= */

model User {
  id               String         @id @default(cuid())
  name             String
  email            String         @unique
  emailVerified    Boolean
  image            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  password         String
  role             Role           @default(USER)
  failedLoginCount Int            @default(0)
  lockedUntil      DateTime?
  lastLoginAt      DateTime?
  lastLoginIp      String?

  addresses        Address[]
  carts            Cart[]
  favorites        Favorite[]
  accounts         Account[]
  comments         Comment[]
  loginAttempts    LoginAttempt[]
  sessions         Session[]
  orders           Order[]
  invoices         Invoice[]
  passwordResetTokens PasswordResetToken[]
  securityLogs SecurityLog[]
  @@map("users")
}

enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILED
  PASSWORD_RESET
  ACCOUNT_LOCKED
}

model SecurityLog {
  id        String            @id @default(cuid())
  eventType SecurityEventType
  userId    String?
  ip        String?
  userAgent String?
  meta      Json?
  success   Boolean           @default(true)
  createdAt DateTime          @default(now())

  user      User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([success, createdAt])
  @@map("security_logs")
}


model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}
model Account {
  id                    String    @id @default(cuid())
  userId                String
  scope                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  accountId             String?
  idToken               String?
  password              String?
  providerId            String?
  refreshToken          String?
  refreshTokenExpiresAt DateTime?
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ipAddress    String?
  userAgent    String?
  sessionToken String?  @unique
  isActive     Boolean  @default(true)
  lastAccessAt DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("sessions")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String?
  email     String
  ipAddress String
  userAgent String?
  success   Boolean
  reason    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@index([userId])
  @@map("login_attempts")
}

model Verification {
  id         String    @id @default(cuid())
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
  identifier String
  value      String
  expiresAt  DateTime
  type       VerificationType?
  used       Boolean?  @default(false)

  @@unique([identifier])
  @@map("verifications")
}

/* =======================
   üì¶ √úR√úN, MARKA, KATEGORƒ∞
======================= */

model Product {
  id           String         @id @default(cuid())
  slug         String         @unique
  name         String
  price        Float
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  discount     Float?
  groupId      String?
  isActive     Boolean        @default(true)
  serial       String?        @unique
  sku          String?
  stock        Int?
  description  String?        @db.Text
  views        Int            @default(0)
  barcode      String?        @unique

  cartItems    CartItem[]
  favorites    Favorite[]
  group        ProductGroup?  @relation(fields: [groupId], references: [id])
  medias       ProductMedia[]
  comments     Comment[]
  attributes   Attribute[]    @relation("ProductAttribute")
  brands       Brand[]        @relation("ProductToBrand")
  categories   Category[]     @relation("ProductToCategory")
  orderItems   OrderItem[]

  @@index([slug])
  @@index([isActive])
  @@map("Product")
}

model ProductGroup {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?   @db.Text
  products    Product[]

  @@map("ProductGroup")
}

model ProductMedia {
  productId String
  mediaId   String
  order     Int
  media     Media   @relation(fields: [mediaId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@id([productId, mediaId])
  @@map("ProductMedia")
}

model Brand {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?

  // ‚úî Marka birden fazla g√∂rsel alabilir
  // ‚úî Bir g√∂rsel birden fazla markada kullanƒ±labilir
  medias      Media[]   @relation("BrandToMedia")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[] @relation("ProductToBrand")

  @@map("Brand")
}

model Category {
  id          String     @id @default(cuid())
  slug        String     @unique
  name        String
  description String
  parentId    String?
  order       Int         @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children    Category[] @relation("CategoryHierarchy")
  medias      Media[]    @relation("CategoryToMedia")
  products    Product[]  @relation("ProductToCategory")
  banners   Banner[]  // üëà kategoriye baƒülƒ± banner'lar


  @@map("Category")
}

/* =======================
   üßæ FAV, YORUM, ATTRIBUTES
======================= */

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("Favorite")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  rating    Int
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("comments")
}

model AttributeGroup {
  id         String      @id @default(cuid())
  name       String
  attributes Attribute[] @relation("GroupAttributes")

  @@map("AttributeGroup")
}

model Attribute {
  id       String         @id @default(cuid())
  name     String
  groupId  String
  group    AttributeGroup @relation("GroupAttributes", fields: [groupId], references: [id])
  medias   Media[]        @relation("AttributeToMedia")
  products Product[]      @relation("ProductAttribute")

  @@map("Attribute")
}

/* =======================
   üõí CART, ORDER, INVOICE
======================= */

model Cart {
  id        String     @id @default(cuid())
  userId    String?
  sessionId String?
  expiresAt DateTime?
  status    CartStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User?      @relation(fields: [userId], references: [id])
  items     CartItem[]

  @@index([userId])
  @@index([sessionId])
  @@index([status, expiresAt])
  @@map("Cart")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  price     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("CartItem")
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  fullName    String
  phone       String
  addressLine String
  city        String
  district    String
  postalCode  String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]

  @@map("Address")
}

model Order {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  subtotal        Float
  shippingCost    Float
  total           Float
  status          OrderStatus @default(PENDING)
  addressId       String?
  address         Address?    @relation(fields: [addressId], references: [id])
  shippingName       String
  shippingPhone      String
  shippingAddress    String
  shippingCity       String
  shippingDistrict   String
  shippingPostalCode String
  deliveryMethod  String
  deliveryDate    DateTime?
  paymentMethod   String
  orderItems      OrderItem[]
  invoiceId       String?      @unique
  invoice         Invoice?     @relation("OrderInvoice", fields: [invoiceId], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId])
  @@index([status])
  @@map("Order")
}

model OrderItem {
  id           String   @id @default(cuid())
  orderId      String
  productId    String
  quantity     Int
  price        Float
  productName  String
  productImage String?
  createdAt    DateTime @default(now())
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id])

  @@map("OrderItem")
}

model Invoice {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  order          Order?       @relation("OrderInvoice")
  type           InvoiceType  @default(INDIVIDUAL)
  fullName       String?
  tcNumber       String?
  companyName    String?
  taxOffice      String?
  taxNumber      String?
  addressLine    String
  city           String
  district       String
  postalCode     String?
  email          String?
  phone          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

/* =======================
   üñºÔ∏è MEDIA & VARIANT
======================= */

model Media {
  id          String         @id @default(cuid())
  type        MediaType
  title       String?
  description String?
  altText     String?
  metadata    Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  productMedia ProductMedia[]
  attributes   Attribute[]    @relation("AttributeToMedia")
  brands       Brand[]      @relation("BrandToMedia")
  categories   Category[]     @relation("CategoryToMedia")
  banners   Banner[] 

  variants     MediaVariant[] @relation("MediaToVariant")
  tags         MediaTag[]     @relation("MediaToTag")
  relations    MediaRelation[] @relation("MediaToRelation")

  @@map("Media")
}

model MediaVariant {
  id        String   @id @default(cuid())
  key       String
  cdnUrl    String
  format    String?
  width     Int?
  height    Int?
  size      Int?
  type      VariantType
  mediaId   String
  media     Media @relation("MediaToVariant", fields: [mediaId], references: [id], onDelete: Cascade)

  @@map("MediaVariant")
}

model MediaTag {
  id         String   @id @default(cuid())
  name       String
  confidence Float?
  type       TagType
  mediaId    String
  media      Media @relation("MediaToTag", fields: [mediaId], references: [id], onDelete: Cascade)

  @@map("MediaTag")
}

model MediaRelation {
  id         String   @id @default(cuid())
  mediaId    String
  entityType RelationType
  entityId   String
  media      Media @relation("MediaToRelation", fields: [mediaId], references: [id], onDelete: Cascade)

  @@map("MediaRelation")
}





model Banner {
  id          String          @id @default(cuid())

  // Metin i√ßerikleri
  title       String?
  subtitle    String?
  description String?

  // G√∂rsel
  mediaId     String
  media       Media           @relation(fields: [mediaId], references: [id])

  // Hangi sayfada / konumda?
  placement   BannerPlacement @default(HOME)

  // Eƒüer CATEGORY ise, hangi kategori?
  categoryId  String?
  category    Category?       @relation(fields: [categoryId], references: [id])

  // Link bilgisi
  linkType    BannerLinkType  @default(NONE)
  linkUrl     String?         // /product/...  /category/...  /brand/...  veya tam URL

  // Cihaz kƒ±rƒ±lƒ±mƒ±
  device      BannerDevice    @default(ALL)

  // Sƒ±ralama
  order       Int             @default(0)

  // Zamanlama (kampanya i√ßin)
  startsAt    DateTime?
  endsAt      DateTime?

  // Aktif / pasif
  isActive    Boolean         @default(true)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([placement, device, isActive, order])
  @@index([placement, categoryId, device, isActive, order])
  @@map("banners")
}

/* =======================
   üî¢ ENUM TANIMLARI
======================= */

enum Role {
  USER
  ADMIN
}

enum VerificationType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  BANNER
  ICON
  LOGO
}

enum VariantType {
  ORIGINAL
  WEBP
  MOBILE
  THUMBNAIL
  OG_IMAGE
  AVIF
}

enum TagType {
  COLOR
  OBJECT
  THEME
  SCENE
}

enum RelationType {
  PRODUCT
  CATEGORY
  BRAND
  CAMPAIGN
  BLOG
}

enum CartStatus {
  ACTIVE
  ABANDONED
  SAVED
  CHECKEDOUT
  COMPLETED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  COMPLETED
  CANCELED
  RETURNED
  REFUNDED
}

enum InvoiceType {
  INDIVIDUAL
  CORPORATE
}


enum BannerPlacement {
  HOME      // Ana sayfa
  CATEGORY  // Kategori sayfasƒ±
}

enum BannerDevice {
  ALL
  DESKTOP
  MOBILE
}

enum BannerLinkType {
  NONE
  PRODUCT
  CATEGORY
  BRAND
  CUSTOM // Tam URL (https://... veya /path)
}